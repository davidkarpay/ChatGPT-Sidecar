<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sidecar Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font: 15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; margin: 2rem; }
    header { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 1rem; align-items: end; }
    input[type=text], input[type=number] { padding: .5rem; width: 100%; }
    button { padding: .5rem .75rem; cursor: pointer; }
    .row { display:flex; gap:.5rem; }
    .hit { padding: 1rem; border:1px solid #e5e7eb; border-radius:.5rem; margin:.75rem 0; }
    .title { font-weight:700; margin-bottom:.25rem; }
    .meta { color:#6b7280; font-size:12px; margin-top:.25rem; }
    mark { background:#fffd8a; }
    #status { min-height: 1.2em; color:#6b7280; margin-top:.5rem; }
    #error { color:#b91c1c; margin-top:.5rem; white-space:pre-wrap; }
    .controls { display:flex; gap:.5rem; margin-top:.5rem; }
  </style>
</head>
<body>
  <h1>Sidecar Search</h1>
  <header>
    <div><label>API Key</label><input id="apiKey" type="text" placeholder="X-API-Key"></div>
    <div><label>Query</label><input id="q" type="text" placeholder="Search…"></div>
    <div><label>k</label><input id="k" type="number" min="1" max="30" value="8"></div>
    <div>
      <label>Advanced (candidates / lambda)</label>
      <div class="row">
        <input id="candidates" type="number" min="10" max="200" value="50">
        <input id="lambda" type="number" step="0.05" min="0" max="1" value="0.5">
      </div>
    </div>
    <div class="row">
      <button id="btnSearch">Search</button>
      <button id="btnAdvanced">Advanced</button>
    </div>
  </header>

  <div id="status"></div>
  <div id="error" aria-live="polite"></div>
  <div id="results"></div>

<script>
const el = (sel)=>document.querySelector(sel);
const apiKeyInput = el('#apiKey'); apiKeyInput.value = localStorage.getItem('API_KEY') || '';
apiKeyInput.addEventListener('input', ()=>localStorage.setItem('API_KEY', apiKeyInput.value));

function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])); }
function safeHighlight(text, terms){
  let safe = escapeHTML(text);
  if(!terms.length) return safe;
  // highlight by wrapping exact safe substrings (case-insensitive)
  for(const t of terms){
    if(!t) continue;
    const re = new RegExp(`(${t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi');
    safe = safe.replace(re, '<mark>$1</mark>');
  }
  return safe;
}
function present(hit, terms){
  const d = document.createElement('div');
  d.className = 'hit';
  const title = escapeHTML(hit.source || '');
  const preview = safeHighlight(hit.preview || '', terms);
  d.innerHTML = `
    <div class="title">${title} <small>score: ${Number(hit.score||0).toFixed(3)}</small></div>
    <div class="snippet">${preview}</div>
    <div class="meta">doc ${hit.loc.doc_id} • chunk ${hit.loc.chunk_id} • [${hit.loc.start}–${hit.loc.end}]</div>
    <div class="controls"><button class="copy">Copy context</button></div>
  `;
  d.querySelector('.copy').onclick = async ()=>{
    try {
      await navigator.clipboard.writeText(JSON.stringify(hit.context_json, null, 2));
      el('#status').textContent = 'Copied context to clipboard.';
      setTimeout(()=> el('#status').textContent = '', 1500);
    } catch (e) {
      el('#error').textContent = 'Copy failed. ' + (e?.message || '');
    }
  };
  return d;
}
async function postJSON(path, body){
  const res = await fetch(path, {
    method: 'POST',
    headers: {'Content-Type':'application/json','X-API-Key': localStorage.getItem('API_KEY') || ''},
    body: JSON.stringify(body)
  });
  if(!res.ok){
    let msg = await res.text();
    try { const j = JSON.parse(msg); msg = j.detail || msg; } catch {}
    throw new Error(msg);
  }
  return res.json();
}
function renderResults(data, query){
  const terms = (query||'').split(/\s+/).filter(Boolean);
  const out = el('#results'); out.innerHTML = '';
  (data.hits || []).forEach(h => out.appendChild(present(h, terms)));
}
function setBusy(b){ el('#status').textContent = b ? 'Searching…' : ''; }
function setError(msg){ el('#error').textContent = msg || ''; }

const runSearch = async ()=>{
  const query = el('#q').value.trim();
  const k = Number(el('#k').value);
  setError(''); setBusy(true);
  try { const data = await postJSON('/search', { query, k }); renderResults(data, query); }
  catch(e){ setError(String(e.message||e)); }
  finally { setBusy(false); }
};
const runAdvanced = async ()=>{
  const query = el('#q').value.trim();
  const k = Number(el('#k').value);
  const candidates = Number(el('#candidates').value);
  const lambda = Number(el('#lambda').value);
  setError(''); setBusy(true);
  try { const data = await postJSON('/search/advanced', { query, k, candidates, lambda: lambda }); renderResults(data, query); }
  catch(e){ setError(String(e.message||e)); }
  finally { setBusy(false); }
};

el('#btnSearch').onclick = runSearch;
el('#btnAdvanced').onclick = runAdvanced;

// Debounce Enter typing on query
let deb; el('#q').addEventListener('input', ()=>{
  clearTimeout(deb);
  deb = setTimeout(()=>{}, 300);
});
el('#q').addEventListener('keydown', e=>{
  if(e.key==='Enter'){ runSearch(); }
});
</script>
</body>
</html>